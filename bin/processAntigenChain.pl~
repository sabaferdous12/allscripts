#!/usr/bin/perl -s
#*************************************************************************
#
#   Program:    processAntigenChain
#   File:       processAntigenChain.pl
#
#   Version:    V1.0
#   Date:       04.01.16
#   Function:   Restoring Antigen chains from PDB and relabeling as 1 if
#               antigen has L or H chain label
#
#   Copyright:  (c) Saba Ferdous, UCL, 2015
#   Author:     Saba Ferdous
#   Address:    Institute of Structural and Molecular Biology
#               Division of Biosciences
#               University College
#               Gower Street
#               London
#               WC1E 6BT
#   EMail:      saba@bioinf.org.uk
#
#*************************************************************************
#
#   This program is not in the public domain, but it may be copied
#   according to the conditions laid out in the accompanying file
#   COPYING.DOC
#                                                                  
#   The code may be modified as required, but any modifications must be
#   documented so that the person responsible can be identified. If
#   someone else breaks this code, I don't want to be blamed for code
#   that does not work!
#
#   The code may not be sold commercially or included as part of a
#   commercial product except as described in the file COPYING.DOC.
#
#*************************************************************************

use strict;
use warnings;
use general qw (readDirPDB);
use pdb qw (get_pdb_path);
use antigenProcessing qw (getAntigenChains);
use Cwd;
UsageDie() if(defined($::h));

my $dir = getcwd ();

my @dirFiles = readDirPDB($dir);
 
my @antigenPDB;
my $flag = 0;
`mkdir -p processed`;

foreach my $pdbFile (@dirFiles)
{
    chomp $pdbFile;
    print "Processing $pdbFile ...\n";
    
    my $abFileTemp = "tempAB.pdb";
    my $abFile = "pro^$pdbFile";
    my $antigen = "tempAg.pdb";
    
    # Get 1AFV from 1AFV_1.pdb
    my ($pdbCode, $ext) = split('_',  $pdbFile);

    # Get original PDB path from local PDB
    my $pdbPath = get_pdb_path ($pdbCode);
    
    my @antigenChains = getAntigenChains($pdbFile);
    open (my $IN, '<', $pdbFile) or die "Error - Cannot open input file $!\n ";
    open (my $ABTMP,'>>', $abFileTemp) or die "Error - Cannot open file for writing\n";
    open (my $AB,'>>', $abFile) or die "Error - Cannot open file for writing\n";
    
    open (my $AG, '>', $antigen) or die "Error....\n";
    
    # Write antibody chains in this file
    while ( my $line = <$IN>) {
        if ( ( $line =~ m/^REMARK/) or ( ( $line =~ /\s+L\s+/) and ($line =~/^ATOM|^TER/) )
                 or ( ( $line =~ /\s+H\s+/) and ($line =~/^ATOM|^TER/) ) ) {
            print {$ABTMP} $line;
        }
    }
    # obtaining orignal antigen chain from local PDB file
    # this is to include any HETATM records in start, middle or end of antigen chain
    my $count = 1;    
    foreach my $ag (@antigenChains)
    {
        @antigenPDB = `pdbatoms $pdbPath | pdbgetchain $ag`;
        # If antigen chain has L or H chain label then rename it as A
        if ( ( $ag eq "L" ) or ($ag eq "H") ) {
            print {$AG} @antigenPDB;
            `pdbchain -c $count $antigen $count.pdb`;
            $flag = 1;
         }
        # For normal chain labels
        else {
            # print all lines except master and END record
            map { if ($_ !~ /MASTER|END|HOH/)  {print {$ABTMP} $_;}} @antigenPDB;
            
        }
                
        @antigenPDB = ();
        # If antigen chain has been renamed then concatenate renamed file with AB file
        if ( $flag ) {
            `cat $abFileTemp $count.pdb >$abFile`;
            `unlink $count.pdb`;
            $count++;
            
        }
        else {
            `cp $abFileTemp $abFile`;
        }
        $flag = 0;   
    }
    
    close $AB;
    close $IN;
    `unlink $abFileTemp`;
    `unlink $antigen`;
}


`mv *pro^* processed`;

# All the new files now have extension pro^:
# To remove that and restore original name, run the following bash command


# `for file in * ; do mv -v "$file" "${file#*^}"; done;` 

    
#*************************************************************************
# UsageDie()
# ----------
# Prints a usage message and exits
#
# 08.12.15 Original   By: ACRM
sub UsageDie
{
    print <<__EOF;
processAntigenChain V1.0 (c) 2015, UCL, Saba Ferdous
Usage:  processAntigenChain.pl

processAntigenChain reads all PDB files from current directory
and process antigen chain from antibody-antigen complex by re-
storing it from orignal PDB. It also re-labels chain ID if an
antigen has L or H chain label.
}
__EOF
    exit 0;

}
        
